<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cost Manager API Demo</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#334155; --text:#e5e7eb; --accent:#22d3ee; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background: var(--bg); color:var(--text); }
    header { padding:16px 20px; border-bottom:1px solid var(--muted); display:flex; gap:16px; align-items:center; position:sticky; top:0; background:rgba(15,23,42,.9); backdrop-filter: blur(8px); }
    h1 { margin:0; font-size:18px; font-weight:600; letter-spacing:.3px; }
    .base { display:flex; align-items:center; gap:8px; margin-left:auto; }
    input[type="text"], input[type="number"], input[type="date"], select, textarea {
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--muted); background:#0b1220; color:#e5e7eb;
      outline:none;
    }
    input::placeholder, textarea::placeholder { color:#94a3b8; }
    .wrap { display:grid; grid-template-columns: 360px 1fr; gap:16px; padding:16px; }
    .card { background: var(--panel); border:1px solid var(--muted); border-radius:16px; padding:14px; }
    .card h2 { margin:4px 0 12px 0; font-size:16px; }
    .grid { display:grid; gap:10px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .btn { cursor:pointer; border:none; background: linear-gradient(90deg, #06b6d4, #22d3ee); color:#00131a; padding:10px 14px; border-radius:10px; font-weight:700; }
    .btn.secondary { background:#0b1220; color:#e5e7eb; border:1px solid var(--muted); }
    .btnRow { display:flex; gap:10px; flex-wrap:wrap; }
    .muted { color:#a1a1aa; font-size:12px; }
    pre { margin:0; white-space:pre-wrap; word-break:break-word; }
    #out { min-height:240px; background:#0b1220; border:1px solid var(--muted); border-radius:16px; padding:14px; overflow:auto; }
    .tiny { font-size:12px; }
    .kbd { font-size:11px; padding:2px 6px; border:1px solid var(--muted); border-radius:6px; background:#0b1220; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid var(--muted); border-radius:999px; background:#0b1220; font-size:12px; }
    footer { text-align:center; padding:10px; color:#94a3b8; font-size:12px; border-top:1px solid var(--muted); }
    @media (max-width: 900px) {
      .wrap { grid-template-columns: 1fr; }
      .row { grid-template-columns: 1fr; }
      header { flex-wrap:wrap; gap:8px; }
    }
  </style>
</head>
<body>
<header>
  <h1>Cost Manager API Demo</h1>
  <div class="base">
    <span class="pill">Base URL</span>
    <input id="baseUrl" type="text" value="http://localhost:3000" />
    <button class="btn secondary" id="ping">Health</button>
  </div>
</header>

<div class="wrap">
  <div class="card grid">
    <h2>Users</h2>
    <div class="grid">
      <div class="row">
        <input id="u_id" type="number" placeholder="id (Number, e.g. 123123)" />
        <input id="u_birthday" type="date" placeholder="birthday (YYYY-MM-DD)" />
      </div>
      <div class="row">
        <input id="u_first" type="text" placeholder="first_name" />
        <input id="u_last"  type="text" placeholder="last_name" />
      </div>
      <div class="btnRow">
        <button class="btn" id="addUser">Add User (POST /api/add)</button>
        <button class="btn secondary" id="getUser">Get User (GET /api/users/:id)</button>
        <button class="btn secondary" id="listUsers">List Users (GET /api/users)</button>
      </div>
    </div>
  </div>

  <div class="card grid">
    <h2>Costs</h2>
    <div class="grid">
      <div class="row">
        <input id="c_userid" type="number" placeholder="userid (Number)" />
        <input id="c_sum" type="number" step="0.01" placeholder="sum (Double)" />
      </div>
      <div class="row">
        <input id="c_desc" type="text" placeholder="description" />
        <select id="c_cat">
          <option value="">category…</option>
          <option>food</option>
          <option>health</option>
          <option>housing</option>
          <option>sports</option>
          <option>education</option>
        </select>
      </div>
      <div class="row">
        <input id="c_createdAt" type="datetime-local" />
        <button class="btn secondary" id="setNow">Set Now</button>
      </div>
      <div class="btnRow">
        <button class="btn" id="addCost">Add Cost (POST /api/add)</button>
        <button class="btn secondary" id="getReport">Monthly Report (GET /api/report)</button>
      </div>
      <div class="row">
        <input id="r_year" type="number" placeholder="year (YYYY)" />
        <input id="r_month" type="number" placeholder="month (1..12)" />
      </div>
    </div>
  </div>

  <div class="card grid">
    <h2>Utilities</h2>
    <div class="btnRow">
      <button class="btn secondary" id="about">About (GET /api/about)</button>
      <button class="btn secondary" id="logs">Logs (GET /api/logs)</button>
      <button class="btn secondary" id="currentReport">Current Month Report</button>
      <button class="btn secondary" id="pastReport">Past Month Report (cache)</button>
    </div>
    <div class="muted tiny">Tip: <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> to submit the focused form.</div>
  </div>

  <div class="card grid" style="grid-column: 1 / -1;">
    <div style="display:flex; align-items:center; gap:10px;">
      <h2 style="margin-right:auto;">Output</h2>
      <button class="btn secondary" id="clear">Clear</button>
      <button class="btn secondary" id="copy">Copy</button>
    </div>
    <!-- NEW: Last URL row -->
    <div id="lastUrlRow" class="muted tiny" style="margin: 6px 0 8px 0;">
      Last URL: <span id="lastUrl">—</span>
    </div>
    <pre id="out"></pre>
  </div>
</div>

<footer>
  Simple demo page. Categories allowed: food, health, housing, sports, education.
</footer>

<script>
const $ = (sel) => document.querySelector(sel);
const out = $("#out");
const lastUrlEl = $("#lastUrl");

function log(title, data, status, isErr=false) {
  const ts = new Date().toISOString();
  const badge = isErr ? "❌" : "✅";
  const json = (typeof data === "string") ? data : JSON.stringify(data, null, 2);
  out.textContent += `[${ts}] ${badge} ${title} (status: ${status ?? "-"})\n` + json + "\n\n";
  out.scrollTop = out.scrollHeight;
}

async function request(method, path, body) {
  const base = $("#baseUrl").value.trim().replace(/\/+$/,"");
  const url = base + path;
  // update visible last URL
  if (lastUrlEl) lastUrlEl.textContent = url;

  const opts = { method, headers: { "Content-Type":"application/json" } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(url, opts);
  let dataText = await res.text();
  let data = dataText;
  try { data = JSON.parse(dataText); } catch(_) {}
  return { res, data };
}

function nowLocalISO(dt = new Date()) {
  const pad = (n)=> String(n).padStart(2, "0");
  const y = dt.getFullYear();
  const m = pad(dt.getMonth()+1);
  const d = pad(dt.getDate());
  const h = pad(dt.getHours());
  const mi = pad(dt.getMinutes());
  return `${y}-${m}-${d}T${h}:${mi}`; // for datetime-local
}

$("#setNow").addEventListener("click", () => {
  $("#c_createdAt").value = nowLocalISO();
});

$("#ping").addEventListener("click", async ()=>{
  try {
    const {res, data} = await request("GET", "/health");
    log("GET /health", data, res.status, !res.ok);
  } catch (e) { log("GET /health", e.message, 0, true); }
});

$("#addUser").addEventListener("click", async ()=>{
  const id = +$("#u_id").value;
  const first_name = $("#u_first").value.trim();
  const last_name = $("#u_last").value.trim();
  const birthday = $("#u_birthday").value;
  if (!id || !first_name || !last_name || !birthday) {
    log("Add User (validation)", "All fields are required", 0, true);
    return;
  }
  try {
    const {res, data} = await request("POST", "/api/add", { id, first_name, last_name, birthday });
    log("POST /api/add (user)", data, res.status, !res.ok);
  } catch (e) { log("POST /api/add (user)", e.message, 0, true); }
});

$("#getUser").addEventListener("click", async ()=>{
  const id = +$("#u_id").value;
  if (!id) return log("GET /api/users/:id (validation)", "id required", 0, true);
  try {
    const {res, data} = await request("GET", `/api/users/${id}`);
    log(`GET /api/users/${id}`, data, res.status, !res.ok);
  } catch (e) { log(`GET /api/users/${id}`, e.message, 0, true); }
});

$("#listUsers").addEventListener("click", async ()=>{
  try {
    const {res, data} = await request("GET", "/api/users");
    log("GET /api/users", data, res.status, !res.ok);
  } catch (e) { log("GET /api/users", e.message, 0, true); }
});

$("#addCost").addEventListener("click", async ()=>{
  const userid = +$("#c_userid").value;
  const description = $("#c_desc").value.trim();
  const category = $("#c_cat").value;
  const sum = +$("#c_sum").value;
  const createdAtInput = $("#c_createdAt").value;
  if (!userid || !description || !category || !sum) {
    log("Add Cost (validation)", "userid, description, category, sum are required", 0, true);
    return;
  }
  const payload = { userid, description, category, sum };
  if (createdAtInput) {
    const dt = new Date(createdAtInput);
    if (!isNaN(dt.valueOf())) payload.createdAt = dt.toISOString();
  }
  try {
    const {res, data} = await request("POST", "/api/add", payload);
    log("POST /api/add (cost)", data, res.status, !res.ok);
  } catch (e) { log("POST /api/add (cost)", e.message, 0, true); }
});

$("#getReport").addEventListener("click", async ()=>{
  const userid = +($("#c_userid").value || $("#u_id").value);
  const year = +$("#r_year").value;
  const month = +$("#r_month").value;
  if (!userid || !year || !month) {
    log("GET /api/report (validation)", "userid, year, month are required", 0, true);
    return;
  }
  try {
    const {res, data} = await request("GET", `/api/report?id=${userid}&year=${year}&month=${month}`);
    log(`GET /api/report?id=${userid}&year=${year}&month=${month}`, data, res.status, !res.ok);
  } catch (e) { log("GET /api/report", e.message, 0, true); }
});

$("#currentReport").addEventListener("click", async ()=>{
  const userid = +($("#c_userid").value || $("#u_id").value || 123123);
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth()+1;
  try {
    const {res, data} = await request("GET", `/api/report?id=${userid}&year=${y}&month=${m}`);
    log(`GET /api/report?id=${userid}&year=${y}&month=${m}`, data, res.status, !res.ok);
  } catch (e) { log("GET /api/report (current)", e.message, 0, true); }
});

$("#pastReport").addEventListener("click", async ()=>{
  const userid = +($("#c_userid").value || $("#u_id").value || 123123);
  const now = new Date();
  const past = new Date(now.getFullYear(), now.getMonth()-1, 1);
  const y = past.getFullYear();
  const m = past.getMonth()+1;
  try {
    const {res, data} = await request("GET", `/api/report?id=${userid}&year=${y}&month=${m}`);
    log(`GET /api/report?id=${userid}&year=${y}&month=${m}`, data, res.status, !res.ok);
  } catch (e) { log("GET /api/report (past)", e.message, 0, true); }
});

$("#about").addEventListener("click", async ()=>{
  try {
    const {res, data} = await request("GET", "/api/about");
    log("GET /api/about", data, res.status, !res.ok);
  } catch (e) { log("GET /api/about", e.message, 0, true); }
});

$("#logs").addEventListener("click", async ()=>{
  try {
    const {res, data} = await request("GET", "/api/logs");
    log("GET /api/logs", data, res.status, !res.ok);
  } catch (e) { log("GET /api/logs", e.message, 0, true); }
});

$("#clear").addEventListener("click", ()=> out.textContent = "");
$("#copy").addEventListener("click", async ()=> {
  try {
    await navigator.clipboard.writeText(out.textContent);
    log("Clipboard", "Output copied", 0, false);
  } catch(e) {
    log("Clipboard", "Failed to copy", 0, true);
  }
});

// Keyboard shortcut: Ctrl+Enter on focused fields to submit the relevant action
document.addEventListener("keydown", (e)=> {
  if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
    const active = document.activeElement;
    if (active && active.closest(".card")) {
      const card = active.closest(".card");
      if (card.querySelector("#addUser")) { $("#addUser").click(); }
      if (card.querySelector("#addCost")) { $("#addCost").click(); }
    }
  }
});
</script>
</body>
</html>
